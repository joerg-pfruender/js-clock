<!DOCTYPE html>
<html>
<head>
  <title>timetest</title>
  <script type="text/javascript" src="../main/js/clockFunctions.js"></script>
  <link rel="stylesheet" type="text/css" href="../main/css/clocktest.css">
</head>
<body>
<div id="testroot"></div>
<h3>Test harness for clock</h3>
<input type="time" name="usr_time1">
<input type="time" name="usr_time2">
<section>


  <br>
  <br>
  <br>
  <br>
  <br>

  <div>
    <canvas id="canvastest" width="160" height="160">
    </canvas>
  </div>
  <!--&ndash;&gt;-->
  <script type="text/javascript">


    // http://dynamic-tools.net/toolbox/popUp/

    var cumulativeOffset = function (element) {
      var top = 0, left = 0;
      do {
        top += element.offsetTop || 0;
        left += element.offsetLeft || 0;
        element = element.offsetParent;
      } while (element);

      return {
        top: top,
        left: left
      };
    };


    var mouseHandler = {

      drag: false,
      offsetLeft: 0,
      offsetTop: 0,

      handleEvent: function handleEvent(left, top) {
        console.log("left=" + left + ", top=" + top);

      },

      doMouseDown: function (event) {
        this.drag = true
        xPos = event.pageX;
        yPos = event.pageY;

//    console.log("X=" + xPos + ", Y=" + yPos);

        this.handleEvent(xPos - this.offsetLeft, yPos - this.offsetTop);
      },

      stopDrag: function () {
        this.drag = false
      },
      doMouseUp: function (event) {
        this.stopDrag();
      },

      doMouseOut: function (event) {
        this.stopDrag();
      },

      doMouseMove: function (event) {
        if (this.drag) {
          xPos = event.pageX;
          yPos = event.pageY;

//      console.log("X=" + xPos + ", Y=" + yPos);

          this.handleEvent(xPos - this.offsetLeft, yPos - this.offsetTop);
        }
      }


    }


    var cumulativeOffset = function (element) {
      var top = 0, left = 0;
      do {
        top += element.offsetTop || 0;
        left += element.offsetLeft || 0;
        element = element.offsetParent;
      } while (element);

      return {
        top: top,
        left: left
      };
    };

    var canvas = document.getElementById('canvastest');
    var canvasContext = canvas.getContext('2d');
    canvasClockPainter.paintClock(canvasContext);

    var offset = cumulativeOffset(canvas)
    //    console.log("offset=" + offset.top + ", " + offset.left);
    mouseHandler.offsetLeft = offset.left;
    mouseHandler.offsetTop = offset.top;

    var initialDate = new Date();
    initialDate.setHours(12)
    initialDate.setMinutes(0)
    var lastSelectedDate = initialDate;

    var lastSelectedTime;

    mouseHandler.handleEvent = function handleEvent(offsetFromLeft, offsetFromTop) {
//  console.log("offset from Left=" + offsetFromLeft + ", offset from Top=" + offsetFromTop);
      var numberOfPixelsRightFromCenter = offsetFromLeft - clockRadius;
      var numberOfPixelsBottomFromCenter = offsetFromTop - clockRadius;
      var currentSelectedTime = clockFunctions.getTimeFromCoordinates(numberOfPixelsRightFromCenter, numberOfPixelsBottomFromCenter, lastSelectedDate);
//  console.log(currentSelectedTime.timeAsString)
      if (!lastSelectedTime || currentSelectedTime.timeAsString != lastSelectedTime.timeAsString) {
        lastSelectedTime = currentSelectedTime;
        if (currentSelectedTime.date) {
          lastSelectedDate = currentSelectedTime.date;
        }
        document.getElementsByName("usr_time1")[0].value = currentSelectedTime.timeAsString;//(currentSelectedTime.hours + ":" + currentSelectedTime.minutes)
        canvasClockPainter.clearCanvas(canvasContext)
        canvasClockPainter.paintClock(canvasContext)
        canvasClockPainter.paintClockHand(canvasContext, currentSelectedTime.hours, currentSelectedTime.minutes)
      }
    };

    canvasClockPainter.paintClockHand(canvasContext, 12, 00)

    canvas.addEventListener("mousedown", function (event) {
      mouseHandler.doMouseDown(event);
    }, false);
    canvas.addEventListener("mouseup", function (event) {
      mouseHandler.doMouseUp(event);
    }, false);
    canvas.addEventListener("mousemove", function (event) {
      mouseHandler.doMouseMove(event);
    }, false);
    canvas.addEventListener("mouseout", function (event) {
      mouseHandler.doMouseOut(event);
    }, false);


  </script>

</section>

</body>
</html>